{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Уроки</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="container">
        <h1>Список уроков</h1>

        {% if task_id %}
        <div id="task-status" hx-get="{% url 'task_status' task_id %}" hx-trigger="load, every 5s[!this.classList.contains('task-complete')]" hx-target="this" hx-swap="innerHTML">
            <p>Статус задачи: Загрузка...</p>
        </div>
        <script>
            document.addEventListener('htmx:afterSwap', function(e) {
                if (e.detail.target.id === 'task-status' && e.detail.target.innerHTML.includes('Задача завершена')) {
                    e.detail.target.classList.add('task-complete');
                }
            });
        </script>
        {% endif %}

        <div class="form-section">
            <h2>Создать новый урок</h2>
            <form hx-post="{% url 'lesson_create' %}" hx-target="tbody" hx-swap="afterbegin" hx-on:htmx:after-request="this.reset()">
                {% csrf_token %}
                {% for field in form %}
                    <div>
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {% if field.many_to_many %}
                            <select multiple name="{{ field.name }}" id="{{ field.id_for_label }}" style="min-height: 80px;">
                                {% for option_value, option_label in field.field.choices %}
                                    <option value="{{ option_value }}">{{ option_label }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            {{ field }}
                        {% endif %}
                    </div>
                {% endfor %}
                <button type="submit">Создать урок</button>
            </form>
        </div>

        <table>
            <thead>
                <tr>
                    <th>id</th>
                    <th>Название</th>
                    <th>Описание</th>
                    <th>Предмет</th>
                    <th>Преподаватель</th>
                    <th>Группа</th>
                    <th>Дата и время</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="lessons-tbody">
                {% for lesson in lessons %}
                <tr class="lesson-row" id="lesson-{{ lesson.pk }}">
                    <td>{{ lesson.id }}</td>
                    <td>{{ lesson.title }}</td>
                    <td>{{ lesson.description|truncatewords:5 }}</td>
                    <td>{{ lesson.subject.name }}</td>
                    <td>{{ lesson.teacher.name }}</td>
                    <td>{{ lesson.group.name|default:"—" }}</td>
                    <td>{{ lesson.scheduled_at|date:"d.m.Y H:i" }}</td>
                    <td>
                        <span class="status-{{ lesson.status }}">
                            {{ lesson.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <div class="actions">
                            {% if lesson.status == 'created' %}
                            <form hx-post="{% url 'lesson_complete' lesson.pk %}" hx-target="#lesson-{{ lesson.pk }}" hx-swap="outerHTML" style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit" class="btn-complete">Завершить</button>
                            </form>
                            {% else %}
                            <button class="btn-complete" disabled>Завершить</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="text-align: center; color: #999;">Нет уроков</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>